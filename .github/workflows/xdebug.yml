name: Build Xdebug (Stable)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04  # 使用稳定版本的 Ubuntu
    
    steps:
    - name: Install PHP 7.1 from deadsnakes PPA
      run: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository ppa:ondrej/php -y
        sudo apt-get update
        sudo apt-get install -y php7.1 php7.1-dev php7.1-cli

    - name: Download and compile Xdebug
      run: |
        # 直接下载 Xdebug 2.9.8 源码
        wget -q https://xdebug.org/files/xdebug-2.9.8.tgz
        tar -xzf xdebug-2.9.8.tgz
        cd xdebug-2.9.8
        
        # 编译
        phpize
        ./configure
        make
        
        # 验证编译成功
        if [ -f modules/xdebug.so ]; then
          echo "✅ xdebug.so 编译成功"
          ls -lh modules/xdebug.so
        else
          echo "❌ 编译失败"
          exit 1
        fi

    - name: Upload xdebug.so
      uses: actions/upload-artifact@v4
      with:
        name: xdebug-2.9.8-php7.1
        path: xdebug-2.9.8/modules/xdebug.so